# build MAVProxy for windows

trigger:
  batch: true
  branches:
    include:
      - 'master'
      - 'pr-*'

pr:
  autoCancel: true
  branches:
    include:
    - master
    - 'pr-*'

jobs:

- job: 'Windows'
  pool:
    vmImage: 'windows-latest'
  strategy:
    matrix:
      Python37:
        python.version: '3.7'
        pyinstaller.version: 'pyinstaller'
    maxParallel: 4

  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '$(python.version)'
      architecture: 'x64'

  - script: python -m pip install --upgrade pip
    displayName: 'Install dependencies'

  - script: pip install $(pyinstaller.version)
    name: 'pyinstaller'

  - script: copy ../windows/mavproxy.spec
    workingDirectory: MAVProxy

  - script: pyinstaller --noconfirm --clean mavproxy.spec
    name: 'build'
    workingDirectory: MAVProxy

  - script: python returnVersion.py > version.txt
    workingDirectory: windows

  - script: ISCC.exe /dMyAppVersion=1.8.26 mavproxy.iss
    workingDirectory: windows

  - bash: dist/ddns.exe || test -e "config.json"
    name: run

  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: './windows/output"
      artifactName: 'WindowsInstaller'
